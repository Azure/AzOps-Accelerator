name: "Validate or Deploy"

inputs:
  deploy:
    default: false
  name:
    required: true
on:
  workflow_call:

runs:
  using: 'composite'
  steps:
      #
      # Diff List
      # List index changes
      #
      
      - name: "Diff List"
        shell: pwsh
        run: |
          Import-PSFConfig -Path settings.json -Schema MetaJson -EnableException
          $stateDir = Get-PSFConfigValue -FullName 'AzOps.Core.State'
          $gitDiff = git diff --name-status HEAD^ HEAD -- "$stateDir"
          if ($null -ne $gitDiff) {
            $gitDiff | Write-Host
            $gitDiff | Out-File -FilePath '/tmp/diff.txt'
          }
          else {
            Write-Error -Message 'The validation pipeline failed because there is currently no change to be processed'
            exit 1
          }

      #
      # CustomSorting
      # If CustomSorting is enabled, sort files in diff by the .order file in each directory
      #

      - name: "CustomSorting"
        shell: pwsh
        if: ${{ env.AZOPS_CUSTOM_SORT_ORDER == 'true' }}
        run: |
          ./.scripts/customSorting.ps1

      #
      # Diff
      # Get content from list
      #
      
      - name: "Diff"
        shell: pwsh
        run: |
          $diff = Get-Content -Path '/tmp/diff.txt'
          $deletedContent = $(foreach ($change in $diff) {
            $path = ($change -split "`t")[-1]
            $fileDelContent = git diff --diff-filter=D HEAD^ HEAD --no-prefix --no-renames -- "$path"
            if($null -ne $fileDelContent) {
                $fileDelContent = $fileDelContent -match '^-' -replace '^([^-+ ]*)[-+ ]', '$1'
                Write-Output -InputObject $fileDelContent
            }
          }) | Where-Object { $_ }

          if ($deletedContent.Count -gt 0) {
            Write-Host '##[group]Deleted files content'
            $deletedContent | Write-Host
            Write-Host '##[endgroup]'
            $deletedContent | Out-File -FilePath '/tmp/diffdeletedfiles.txt'
          }

      #
      # Validate or Deploy
      # If parameter "deploy" is set to true, then deploy the changes,
      # Initial deployment of any index changes
      #

      - name: ${{ inputs.name }}
        shell: pwsh
        run: |
          Import-PSFConfig -Path settings.json -Schema MetaJson -EnableException
          $RunWhatIf = -not ('${{inputs.deploy}}' -eq 'true')
          $diff = Get-Content -Path /tmp/diff.txt
          if(Test-Path -Path "/tmp/diffdeletedfiles.txt") {
            $diffdeletedfiles = Get-Content -Path /tmp/diffdeletedfiles.txt
            Invoke-AzOpsPush -ChangeSet $diff -DeleteSetContents $diffdeletedfiles -WhatIf:$RunWhatIf
          } 
          else {
            Invoke-AzOpsPush -ChangeSet $diff -WhatIf:$RunWhatIf
          }
          Get-Job | Remove-Job -Force
