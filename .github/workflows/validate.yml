---
name: "AzOps - Validate"

on:
  #
  # Pull Request
  # Upon the creation of a new Pull Request in the root folder
  # this workflow will execute.
  #

  pull_request:
    paths:
      - "root/**"

env:
  #
  # Credentials
  #

  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}

jobs:
  validate:
    #
    # Validate
    #

    name: "Validate"
    runs-on: ubuntu-20.04

    steps:
      #
      # Checkout
      # Checks-out the repository
      #

      - name: "Checkout"
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      #
      # Dependencies
      # Install required runtime modules
      #

      - name: "Dependencies"
        run: |
          . .github/scripts/Install.ps1
          Install-SourceModule -Repository "RakshanaShanmugam/AzOps" -Branch "Rakshana-mgmGroupTest"
          $module = Get-Module -Name AzOps -ListAvailable
          $data = Import-PowerShellDataFile -Path $module.Path
          foreach ($dependency in $data.RequiredModules) {
              Install-Module -Name $dependency.ModuleName -RequiredVersion $dependency.RequiredVersion -Force
          }
        shell: pwsh

      #
      # Connect
      # Authenticate Azure context
      #

      - name: "Connect"
        shell: pwsh
        run: |
          $credential = New-Object PSCredential -ArgumentList $env:ARM_CLIENT_ID, (ConvertTo-SecureString -String $env:ARM_CLIENT_SECRET -AsPlainText -Force)
          Connect-AzAccount -TenantId $env:ARM_TENANT_ID -ServicePrincipal -Credential $credential -SubscriptionId $env:ARM_SUBSCRIPTION_ID

      #
      # Diff
      # List index changes
      #

      - name: "Diff"
        id: diff
        shell: bash
        run: |
          echo $(git diff --name-status HEAD^ HEAD)
          git diff --name-status HEAD^ HEAD > /tmp/diff.txt
          if [ git diff --diff-filter=D HEAD^ HEAD ];
          then
          echo $(git diff --diff-filter=D HEAD^ HEAD  --no-prefix | grep ^- | sed -r "s/^([^-+ ]*)[-+ ]/\\1/" | less -r) 
          git diff --diff-filter=D HEAD^ HEAD --no-prefix | grep ^- | sed -r "s/^([^-+ ]*)[-+ ]/\\1/" | less -r > /tmp/diffdeletedfiles.txt
          fi

      #
      # Validate
      #

      - name: "Validate"
        shell: pwsh
        run: |
          Initialize-AzOpsEnvironment
          Import-PSFConfig -Path settings.json -Schema MetaJson
          $diff = Get-Content -Path /tmp/diff.txt
          $module = Get-Module -Name AzOps
          if(Test-Path -Path "/tmp/diffdeletedfiles.txt")
          {
          $diffdeletedfiles = Get-Content -Path /tmp/diffdeletedfiles.txt
          Write-Host "diff text" $diff
          Write-Host "diff deleted text" $diffdeletedfiles
          $module.Invoke({ Invoke-AzOpsPush -ChangeSet $diff -DeleteSetContents $diffdeletedfiles -WhatIf })
          }else{
          Write-Host "diff text" $diff
          $module.Invoke({ Invoke-AzOpsPush -ChangeSet $diff -WhatIf })
          }
          Get-Job | Remove-Job -Force

      #
      # Results
      #

      - name: "Results"
        shell: bash
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body-file /tmp/OUTPUT.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
