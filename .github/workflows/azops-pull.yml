name: "AzOps - Pull"

on:
  workflow_dispatch:

jobs:
  pull:
    name: "Pull"
    runs-on: ubuntu-20.04
    steps:
      - name: "Checkout"
        uses: actions/checkout@v2
        with:
          path: azops-starter

      - name: "Checkout"
        uses: actions/checkout@v2
        with:
          repository: ljtill/azops
          path: azops
          ref: dev

      - name: "List"
        run: |
          Get-ChildItem -Path "/usr/share/az*"
        shell: pwsh

      - name: "Install"
        run: |
          Install-Module -Name @("Az.Accounts", "Az.Resources", "PSFramework") -Force
        shell: pwsh

      - name: "Connect"
        run: |
          $ClientId = ($env:CREDENTIALS | ConvertFrom-Json).ClientId
          $ClientSecret = ConvertTo-SecureString -String ($env:CREDENTIALS | ConvertFrom-Json).ClientSecret -AsPlainText -Force
          $TenantId = ($env:CREDENTIALS | ConvertFrom-Json).TenantId
          $SubscriptionId = ($env:CREDENTIALS | ConvertFrom-Json).SubscriptionId
          $Credential = New-Object -TypeName "System.Management.Automation.PSCredential" -ArgumentList $ClientId, $ClientSecret
          Connect-AzAccount -Credential $Credential -Tenant $TenantId -Subscription $SubscriptionId
        env:
          credentials: ${{ secrets.AZURE_CREDENTIALS }}

      - name: "Import"
        run: |
          Import-Module ./src/AzOps.psd1
        shell: pwsh
        working-directory: azops
