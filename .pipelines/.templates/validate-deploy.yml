parameters:
  - name: deploy
    type: boolean
    default: false

steps:

    #
    # Diff
    # List index changes
    #

  - task: PowerShell@2
    displayName: "Diff"
    inputs:
      targetType: "inline"
      script: |
        $gitDiff = git diff --name-status HEAD^ HEAD
        if($null -ne $gitDiff) {
            $gitDiff | Write-Host
            $gitDiff | Out-File -FilePath '/tmp/diff.txt'
            
            $deletedContent = git diff --diff-filter=D HEAD^ HEAD --no-prefix --no-renames
            if($null -ne $deletedContent) {
                $deletedContent = $deletedContent -match '^-' -replace '^([^-+ ]*)[-+ ]', '$1'
                Write-Host '##[group]Deleted files content'
                $deletedContent | Write-Host
                Write-Host '##[endgroup]'
                $deletedContent | Out-File -FilePath '/tmp/diffdeletedfiles.txt'
            }
        }
        else {
            Write-Host '##[error]The validation pipeline failed because there is currently no change to be processed'
            exit 1
        }

    #
    # CustomSorting
    # If CustomSorting is enabled, sort files in diff by the .order file in each directory
    #

  - task: PowerShell@2
    displayName: "CustomSorting"
    condition: eq(variables['AZOPS_CUSTOM_SORT_ORDER'],'true')
    inputs:
      targetType: "inline"
      script: |
        $diff = Get-Content -Path /tmp/diff.txt

        Write-Host '##[section]Files found in diff:'
        $diff | Write-Host

        $diffTable = @{}
        $diff | ForEach-Object -Process {
          $change = $_
          $path = ($change -split "`t")[-1]
          $entry = [pscustomobject]@{
            fileName   = Split-Path -Path $path -Leaf
            directory  = Split-Path -Path $path -Parent
            diffString = $change
          }
          if ($null -eq $diffTable[$entry.directory]) {
            $diffTable[$entry.directory] = @{}
          }
          if($entry.fileName -ne '.order') {
            $diffTable[$entry.directory][$entry.fileName] = $entry
          }
        }

        $sortedDiff = foreach ($directoryPath in ($diffTable.Keys | Sort-Object)) {
          $orderPath = Join-Path -Path $directoryPath -ChildPath '.order'
          if (Test-Path -Path $orderPath) {
            $order = Get-Content -Path $orderPath | ForEach-Object {$_.Trim()}
            foreach ($orderName in $order) {
              if ($null -ne $diffTable.$directoryPath.$orderName) {
                Write-Output -InputObject $diffTable.$directoryPath.$orderName.diffString
                $diffTable.$directoryPath.Remove($orderName)
              }
            }
          }
          Write-Output ($diffTable.$directoryPath.Values.diffString | Sort-Object)
        }

        Write-Host '##[section]Sorted files:'
        $sortedDiff | Write-Host
                
        $sortedDiff | Out-File -Path '/tmp/diff.txt'

  #
  # Validate or Deploy
  # If parameter "deploy" is set to true, then deploy the changes,
  # otherwise validate the changes.
  #

  - task: PowerShell@2
    ${{ if not(eq(parameters.deploy, 'true')) }}:
      displayName: "Validate"
    ${{ else }}:
      displayName: "Deploy"
    inputs:
      targetType: "inline"
      script: |
        $Env:PSModulePath = $Env:PSModulePath, '$(modulesFolder)' -join [IO.Path]::PathSeparator
        $CustomSortOrder = $Env:AZOPS_CUSTOM_SORT_ORDER -eq 'true'
        $RunWhatIf = -not ('${{parameters.deploy}}' -eq 'true')
        Import-PSFConfig -Path settings.json -Schema MetaJson -EnableException
        Initialize-AzOpsEnvironment
        $diff = Get-Content -Path /tmp/diff.txt
        if(Test-Path -Path "/tmp/diffdeletedfiles.txt") {
          $diffdeletedfiles = Get-Content -Path /tmp/diffdeletedfiles.txt
          Invoke-AzOpsPush -ChangeSet $diff -DeleteSetContents $diffdeletedfiles -WhatIf:$RunWhatIf -CustomSortOrder:$CustomSortOrder
        } 
        else {
          Invoke-AzOpsPush -ChangeSet $diff -WhatIf:$RunWhatIf -CustomSortOrder:$CustomSortOrder
        }
        Get-Job | Remove-Job -Force
